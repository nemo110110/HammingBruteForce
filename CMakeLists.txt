cmake_minimum_required(VERSION 3.0)
project(HamingBruteForce CXX)

set(CMAKE_CXX_COMPILER "/usr/local/bin/icpc")
SET(OPTIMIZATION_FLAGS "-O3 -qopenmp -fomit-frame-pointer -march=native")
SET(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OPTIMIZATION_FLAGS} -Wall -std=c++14")

set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/build")
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY "${CMAKE_CURRENT_SOURCE_DIR}/build")


set(SOURCE_FILES_O
        ./build/MathKernels.o)

set(SOURCE_FILES_CPP
        ./src/HamingBruteForce.cpp)

set(SOURCE_FILES_H
        src/HamingBruteForce.h
        src/AlignedAllocator.h)

include_directories(./src)
add_library(HamingBruteForce ${SOURCE_FILES_CPP} ${SOURCE_FILES_H} ${SOURCE_FILES_O})

add_executable(HamingBruteForceExample example/main.cpp example/Timer.h)
target_link_libraries(HamingBruteForceExample HamingBruteForce)

add_custom_command(OUTPUT ${CMAKE_CURRENT_SOURCE_DIR}/build/MathKernels.o
        COMMAND ispc -O2 --arch=x86-64 --target=avx2 --opt=fast-math ./src/MathKernels.ispc -o ./build/MathKernels.o
        MAIN_DEPENDENCY ${CMAKE_CURRENT_SOURCE_DIR}/src/MathKernels.ispc
        WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR})

set_source_files_properties(./src/MathKernels.h ./build/MathKernels.o PROPERTIES EXTERNAL_OBJECT true GENERATED true)